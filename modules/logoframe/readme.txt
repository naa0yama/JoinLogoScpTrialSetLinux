//
// 透過ロゴ表示区間検出 logoframe  by Yobi
// （複数ロゴ同時検出対応版） Ver1.20対応
//

■ 概要

動画から固定位置半透明ロゴが表示されている区間を検出します。

特徴
・自動処理化を目指した高精度なロゴ表示区間の検出
・ロゴ表示開始／終了時のフェードイン／フェードアウト有無を検知


■事前準備

下記を事前に準備してください。

・検出対象のロゴデータファイル(*.lgd または *.lgd2)
  AviUtl用 ロゴ解析プラグインver 0.07で作成したものを使って確認しています。
  lgd2はrigaya氏のSIMD版ソースファイルを参考に読み込んでいます。
  １ファイルに１ロゴ前提でファイル内先頭のロゴを使用します。

・AviSynthの実行環境（2.58以降の32bit版を推奨）
  AVSファイルから動画の読み込みができる環境を用意してください。


■使用方法

batファイル等で下記コマンドを実行します。

logoframe AVSファイル名 -logo ロゴファイル名 -oa 出力ファイル名 他オプション


【必須オプション】

  AVSファイル名
    対象の画像データ入力を記載したAVSファイル名を指定します。
    AVSファイルは、DGIndexを使ったd2v形式をDGDecode_MPEG2Source
    による読み込みで確認しています。輝度のみ使用しています。

  -logo ロゴファイル名
    検出対象のロゴデータファイル名(*.lgd)を指定します。
    ロゴファイル名拡張子前まで完全に含み、拡張子も同じファイルを読み込みます。
    拡張子を省略した場合は".lgd"が付加されます。

  -oa 出力ファイル名
    ロゴ表示区間検出結果を出力します。出力項目は下記の通り。
      フレーム番号   : ロゴ表示開始または終了位置
      開始／終了     : S:開始 または E:終了
      フェード       : フェード時はフレーム数。フェードなしの場合は0
      インターレース : 表示されている箇所 ALL:両方 TOP:トップ BTM:ボトム
      候補範囲フレーム番号 : 位置が不明確な場合、可能性のある範囲を記載
    必ず開始と終了がセットで出力されます。

    ※-oaオプション出力は複数ロゴをまとめたロゴ表示区間結果となります。
      個別ロゴ結果は別ファイルに出力されます（-oamaskオプション参照）。

    ※AVSファイル名以外のオプションは、実行ファイル(logoframe.exe)と
      同じフォルダにあるlogoframe.iniで指定も可能です。


【任意オプション】

  -o 出力ファイル
    検出結果を使ったAVSファイル例を出力します。
    「EraseLOGO」に検出結果を渡す例となっています。

  -outform 数値
    「-o」オプション出力形式を変更します。
    数値 0:「EraseLOGO」呼び出し（オプション省略時もこちら）
         1: 片フィールドロゴにも対応。AVS実行時に別途関数Importする必要あり。

  -logoparam ファイル名
    検出パラメータオプションをファイルから読み込むことができます。
    -fadein  8
    -fadeout 8
    のように１項目を１行に記載したファイルとします。
    このオプションは全ロゴ共通で使われます。
    各個別ロゴの設定方法として、ロゴファイル名の拡張子".lgd"を
    ".logoframe.txt"に変えたファイルがあればそこから読み込みます。

    ※検出パラメータ各指定方法間の優先順位は、高い順に下記の通りです。
      オプション直接指定＞個別ロゴファイル指定＞-logoparamファイル指定

  -logo1 ロゴファイル名
  -logo2 ロゴファイル名
    〜
  -logo100 ロゴファイル名
    検出対象のロゴデータファイル名(*.lgd)を指定します。
    対応するロゴ番号に、完全一致ロゴファイル名のロゴを直接読み込みます。
    「-logo」オプションの代わりに指定、あるいは両方指定も可能です。
    （割当済ロゴ番号を避けて「-logo」オプションのロゴは割り当てられます。）

  -oanum 数値
    「-oa」オプションの複数ロゴまとめ検出に使用するロゴ数を指定します。
    （-logo1〜-logo指定数値までを使用。省略時は90）
    -logoオプション読み込み上限のロゴ数もこのオプション値です。

    （例）-oanum 90を指定した場合、logo1〜logo90までのロゴを「-oa」オプション
          によるまとめ期間に使用、logo91以降は無関係のロゴとします。

  -oasel 数値
    「-oa」オプション結果出力に使用するロゴを表示区間から限定します。
     ロゴ表示区間が全く同じ場合はロゴ番号の小さい方を優先します。
    数値 0: ロゴ表示区間が長い順に期間重複なければ選択（オプション省略時設定）
         1: ロゴ表示区間が一番長いロゴ１つだけを選択。
         2: まとめ検出ロゴ全部のOR。

  -oamask 数値
    「-oa」オプションの個別ロゴ結果をファイル出力するか選択します。
    0の時全ファイル出力で、出力しない場合は対応する数値を加算します。
    数値 1: -oaselで対象外となったロゴは出力しない
           （ファイル名：-oaファイル名+"_X*"）
         2: -oanum以上ロゴ番号のまとめ検出とは無関係のロゴは出力しない
           （ファイル名：-oaファイル名+"_S*"）
         4: まとめ検出対象の個別ロゴは出力しない
           （ファイル名：-oaファイル名+"_*"）
         8: 個別ロゴ情報リストは出力しない
           （ファイル名：-oaファイル名+"_list.ini"）
    上記ファイル名補足：*は表示期間の長い順に1から順番の数値を表し、
                       .ini以外は-oaと同じ拡張子
    個別ロゴ情報リストには、[logodata]セクションで下記項目が出力されます。
      FrameTotal    : 映像のフレーム数
      LogoName_N*   : ロゴデータファイル名
      FrameSum_N*   : ロゴ表示期間の合計フレーム数
      OrgLogoNum_N* : 検出時のロゴ番号
      oaFileName_N* : -oaオプション相当の個別ロゴ結果ファイル名
    *は1から順番の数値、-oamask項目にあるロゴ種類によりN部分はS,Xに変化。

  -oa2 出力ファイル
    デバッグ用に１画像毎のロゴ検出値を出力します。出力項目は下記。
      フレーム番号      : 対象のフレーム番号
      ロゴ表示検出      : ロゴ検出状態を0:ロゴ無〜100:ロゴ有として出力
      不確定度          : 0:ほぼ確定〜3:不確定度大、9:検出不可
      フェード割合(TOP) : 0〜100でフェード検出値を出力（トップフィールド）
      フェード割合(BTM) : 0〜100でフェード検出値を出力（ボトムフィールド）
      以降の項目はデバッグ用にいろいろ出力
      複数ロゴ指定時は、出力ファイル名に"_n"（n:1〜のロゴ番号）をつけた
      名前で出力されます。
    ※ロゴ数に比例してファイルが増加するので、複数ロゴでは指定せず出力しない
      ことを推奨します。

  -paramoff 数値
    1を設定したら各ロゴのパラメータ情報を表示しません。
    ロゴが多くなると表示が多くなるため、見る必要なければ指定してください。

  -dispoff  数値
    1を設定したら標準出力に表示しているメッセージを出しません。

  -F ファイル名
    ロゴ関連オプションをファイルから読み込むことができます。
    付属"logoframe.ini"の形式、または
    -oanum 7
    -logo7 "C:\logo\logo.lgd"
    のように１項目を１行に記載したファイルとします。


【検出パラメータオプション】

  標準的なロゴでは特に指定不要です。
  手動で最適化する場合は下記記載のオプションを指定します。

  フェードは指定しなければ自動検出モードとなり、フレーム数=8で検出し
  誤検出を避けるため半数以上の箇所で検出した場合のみフェード有効となります。
  フェード指定の最大フレーム数は30。

  -fadein フレーム数
    ロゴ表示開始時の中間状態フレーム数を指定します。
    指定したフェード／フェードなしの判定は自動で行います。
    初期値：0[自動検出]（自動検出した場合：8）

  -fadeout フレーム数
    ロゴ表示終了時の中間状態フレーム数を指定します。
    指定したフェード／フェードなしの判定は自動で行います。
    初期値：0[自動検出] （自動検出した場合：8）

  -mrgleft フレーム数
    開始直後、指定フレーム数より前に終了するロゴ表示は無視します。
    初期値：500

  -mrgright フレーム数
    最終フレームから指定フレーム数引いた位置後に開始するロゴ表示は無視します。
    初期値：150

  -onwidth フレーム数
    ロゴ表示開始（終了）判定に使用するフレーム数を指定します。
    指定したフレーム数の間のロゴ有無継続で開始（終了）判断されます。
    初期値：25

  -offwidth フレーム数
    ロゴ表示終了判定に使用するフレーム数を指定します。
    指定したフレーム数の間ロゴなし判定されていたら終了と判断されます。
    0の時は-onwidthの値が使用されます。
    初期値：0

  -onlevel 数値
    ロゴ表示開始終了判定の感度を指定します。数値が大きいと切り替わり見逃しは
    減りますが誤検出が増えます。指定する場合は10〜30。
    初期値：21

  -yedge 輝度値
    指定輝度値を超えたらエッジ検出による判別を行いません。
    高輝度でエッジ検出ができないロゴのみ指定します。
    初期値：255 （自動検出でBS11と判断した場合：220）

  -yoffedg 輝度値
    指定輝度値を超えたらエッジ検出でロゴなしと判断しても不確定扱いにします。
    輝度が高いとロゴが崩れた状態のまま継続されるロゴで指定します。
    この値を254以下に設定したらロゴ影部分の微妙な検出も行いません。
    初期値：255

  -ymax 輝度値
    輝度最大値を指定します。ロゴ輝度計算に使用します。
    初期値：235

  -ymin 輝度値
    輝度最小値を指定します。ロゴ輝度計算に使用します。
    初期値：16

  -ydif 輝度差16倍
    ロゴのエッジ検出を行う最低輝度差（輝度1につき16）を指定します。
    小さくすると検出上がるかわりに誤差の影響を受けやすくなります。
    初期値：40

  -ysetdif 輝度値
    指定輝度値でエッジ検出をしないydif値であれば補正します。
    ただし補正ydifの最小値は24。0を指定した時は補正しません。
    初期値：222

  -clrrate 数値
    不明確な検出だけのロゴは、指定数値分の１以下のフレームしか
    検出がなければ無効とします。0の時は無効化処理を行いません。
    初期値：8

■ 謝辞

logoframe作成にあたり、AviSynth関連下記ソフトのソースコード(GPL)を
参考にしました。作者に感謝します。

Avs2YUV  （Loren Merritt氏他）
透過性ロゴフィルタ delogo  （MakKi氏）


■ 最後に

技術的興味から作ってみたフリーソフトウェアで、サポートしていく予定はありません。
GPLを利用しているのでこのソフトもGPLとします。
